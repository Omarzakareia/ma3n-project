<%@ Page Title="" Language="C#" MasterPageFile="~/MasterPage.Master" AutoEventWireup="true" CodeBehind="Departments.aspx.cs" Inherits="HospitalSystem.Doctors.Departments" %>
<asp:Content ID="Content1" ContentPlaceHolderID="head" runat="server">
</asp:Content>
<asp:Content ID="Content2" ContentPlaceHolderID="ContentPlaceHolder1" runat="server">
    <telerik:RadGrid ID="RadGrid1" runat="server" AllowFilteringByColumn="True" AllowPaging="True" AllowSorting="True" AutoGenerateDeleteColumn="True" AutoGenerateEditColumn="True" DataSourceID="SmallHospital" OnNeedDataSource="RadGrid1_NeedDataSource" ShowFooter="True" Skin="Silk">
        <GroupingSettings CollapseAllTooltip="Collapse all groups"></GroupingSettings>

        <ClientSettings>
            <Scrolling AllowScroll="True" UseStaticHeaders="True" />
        </ClientSettings>

        <MasterTableView AutoGenerateColumns="False" DataKeyNames="DepartmentID" DataSourceID="SmallHospital" ShowFooter="False" AllowAutomaticDeletes="true"
            AllowAutomaticUpdates="true" BackColor="#FFC0C0" BorderColor="Black" BorderStyle="Solid" AllowAutomaticInserts="True">
      <DetailTables>
    <telerik:GridTableView runat="server" DataKeyNames="DoctorID" DataSourceID="Doctors" AutoGenerateColumns="False">
        <ParentTableRelation>
            <telerik:GridRelationFields MasterKeyField="DepartmentID" DetailKeyField="DepartmentID" />
        </ParentTableRelation>

<RowIndicatorColumn ShowNoSortIcon="False"></RowIndicatorColumn>

<ExpandCollapseColumn ShowNoSortIcon="False"></ExpandCollapseColumn>
        <Columns>
            <telerik:GridBoundColumn DataField="DoctorName" HeaderText="Doctor Name" UniqueName="DoctorName" />
            <telerik:GridBoundColumn DataField="SpecialityName" HeaderText="Specialty" UniqueName="SpecialityName" />
        </Columns>

<EditFormSettings>
<EditColumn ShowNoSortIcon="False"></EditColumn>
</EditFormSettings>
    </telerik:GridTableView>
</DetailTables>



            <RowIndicatorColumn ShowNoSortIcon="False"></RowIndicatorColumn>
            <ExpandCollapseColumn ShowNoSortIcon="False"></ExpandCollapseColumn>
            <Columns>
                <telerik:GridBoundColumn DataField="DepartmentName" FilterControlAltText="Filter DepartmentName column" HeaderText="Department Name" ShowNoSortIcon="False" SortExpression="DepartmentName" UniqueName="DepartmentName" />
                <telerik:GridTemplateColumn HeaderText="Assign Doctor">
    <ItemTemplate>
        <!-- Dropdown to select doctor -->
        <asp:DropDownList ID="ddlDoctors" runat="server" AppendDataBoundItems="true">
            <asp:ListItem Text="Select Doctor" Value="" />
        </asp:DropDownList>

        <!-- Assign button -->
        <asp:Button ID="btnAssignDoctor" runat="server" Text="Assign" CommandName="AssignDoctor" CommandArgument='<%# Eval("DepartmentID") %>' />
    </ItemTemplate>
</telerik:GridTemplateColumn>


                <telerik:GridBoundColumn DataField="DepartmentID" DataType="System.Int32" FilterControlAltText="Filter DepartmentID column" HeaderText="Department ID" ReadOnly="True" ShowNoSortIcon="False" SortExpression="DepartmentID" UniqueName="DepartmentID" Visible="False" />
            </Columns>
            <EditFormSettings>
                <EditColumn ShowNoSortIcon="False"></EditColumn>
            </EditFormSettings>
        </MasterTableView>
    </telerik:RadGrid>

 <asp:SqlDataSource ID="Doctors" runat="server" ConnectionString="<%$ ConnectionStrings:InternSmallHospitalConnectionString %>"
    SelectCommand="SELECT d.DoctorID, u.FullName AS DoctorName, s.SpecialityName, d.DepartmentID 
                   FROM Doctor d 
                   INNER JOIN [User] u ON d.UserID = u.UserID 
                   INNER JOIN Speciality s ON d.SpecialityID = s.SpecialityID
                   WHERE d.DepartmentID = @DepartmentID">
    <SelectParameters>
        <asp:ControlParameter Name="DepartmentID" ControlID="RadGrid1" PropertyName="SelectedValue" Type="Int32" />
    </SelectParameters>
</asp:SqlDataSource>
    <asp:SqlDataSource ID="DoctorsList" runat="server" ConnectionString="<%$ ConnectionStrings:InternSmallHospitalConnectionString %>"
    SelectCommand="SELECT d.DoctorID, u.FullName AS DoctorName 
                   FROM Doctor d 
                   INNER JOIN [User] u ON d.UserID = u.UserID
                   WHERE d.DepartmentID IS NULL OR d.DepartmentID = 0">
</asp:SqlDataSource>




    
    <asp:SqlDataSource ID="SmallHospital" runat="server" ConflictDetection="CompareAllValues" ConnectionString="<%$ ConnectionStrings:InternSmallHospitalConnectionString %>"
        DeleteCommand="DELETE FROM [Department] WHERE [DepartmentID] = @original_DepartmentID AND [DepartmentName] = @original_DepartmentName"
        InsertCommand="INSERT INTO [Department] ([DepartmentName]) VALUES (@DepartmentName)" OldValuesParameterFormatString="original_{0}"
        OnSelecting="SmallHospital_Selecting"
        SelectCommand="SELECT [DepartmentName], [DepartmentID] FROM [Department]"
        UpdateCommand="UPDATE [Department] SET [DepartmentName] = @DepartmentName WHERE [DepartmentID] = @original_DepartmentID AND [DepartmentName] = @original_DepartmentName">
        <DeleteParameters>
            <asp:Parameter Name="original_DepartmentID" Type="Int32" />
            <asp:Parameter Name="original_DepartmentName" Type="String" />
        </DeleteParameters>
        <InsertParameters>
            <asp:Parameter Name="DepartmentName" Type="String" />
        </InsertParameters>
        <UpdateParameters>
            <asp:Parameter Name="DepartmentName" Type="String" />
            <asp:Parameter Name="original_DepartmentID" Type="Int32" />
            <asp:Parameter Name="original_DepartmentName" Type="String" />
        </UpdateParameters>
    </asp:SqlDataSource>
    
</asp:Content>